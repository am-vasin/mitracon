*
*    Программа коррекции брони по позиции
*
PROCEDURE Rem_Sav
PARAMETER s_code

PRIVATE s_sav, br_w

s_sav = SELECT()

SELECT 0
USE (base_path+"LIST_TIT") ORDER TAG LST_NUM ALIAS LT17698 AGAIN

SELECT 0
USE (base_path+"LIST_DET") ORDER TAG CODE ALIAS LD17698 AGAIN
*SET RELATION TO VAL(ALLTRIM(LIST_NUM)) INTO LT17698

SELECT 0
USE (base_path+"STOCK") ORDER TAG CODE ALIAS ST17698 AGAIN

br_w = 0
IF .NOT. SEEK(s_code)
  WAIT WIND "Нет такой позиции в номенклатуре!"
ELSE
  SELECT LD17698
  SEEK s_code
  SCAN REST WHILE CODE = s_code FOR QNT_REQ # 0
    IF .NOT. SEEK(VAL(ALLTRIM(LIST_NUM)),"LT17698")
      LOOP
    ENDIF
    IF EMPTY(LT17698.SAL_NUM)
*      WAIT WIND STR(QNT_REQ)+LIST_NUM
      br_w = br_w+QNT_REQ
    ENDIF
  ENDSCAN
*  WAIT WIND STR(BR_W) NOWAIT
  SELECT ST17698
  REPLACE ST17698.QNT WITH ST17698.QNT+ST17698.QNT_SAVE-br_w, ;
          ST17698.QNT_SAVE WITH br_w
  ?  ST17698.NAME
  ?? IIF(BR_W = ST17698.QNT_SAVE, "  OK!", " BAD!")
ENDIF

SELECT ST17698
USE

SELECT LT17698
USE

SELECT LD17698
USE

SELECT (s_sav)

RETURN
