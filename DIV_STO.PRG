*
*   Делим номенклатуру
*
PROCEDURE Div_Sto
PRIVATE tmpSw, nn

CLOSE DATABASES
DELETE FILE (base_path+"DIV_STO.DBF")
DELETE FILE (base_path+"DIV_STO.CDX")

CREATE DBF (base_path+"DIV_STO") ;
   ( CODE   N( 7), ;
     IS_MT  L,     ;
     QNT_TE N(10), ;
     QNT_MT N(10)  )

SELECT 0
USE (base_path+"STOCK")
SET FILTER TO EMPTY(DATE_OFF)

nn = 0
SCAN
  nn = nn+1
  IF nn % 100 = 0
    WAIT WINDOW STR(nn) NOWAIT
  ENDIF
  tmpSw = Is_Mitr(ADDRESS)
  REPLACE QNT WITH QNT+QNT_SAVE
  REPLACE QNT_SAVE WITH 0
  SELECT DIV_STO
  APPEND BLANK
  REPLACE CODE  WITH STOCK.CODE, ;
          IS_MT WITH Is_Mitr(STOCK.ADDRESS)
  IF IS_MT
    REPLACE QNT_MT WITH STOCK.QNT
  ELSE
    REPLACE QNT_TE WITH STOCK.QNT
  ENDIF
  SELECT STOCK
ENDSCAN

USE
SELECT DIV_STO
INDEX ON CODE TAG CODE
SET ORDER TO TAG CODE
*
*   Переносим бронь
*
SELECT 0
USE (base_path+"LIST_DET") ORDER TAG LIST
SET RELATION TO CODE INTO DIV_STO
SELECT 0
USE (base_path+"LIST_TIT")
SCAN FOR EMPTY(SAL_NUM)
  SELECT LIST_DET
  WAIT WIND STR(LIST_TIT.LST_NUM, 6) NOWAIT
  SEEK STR(LIST_TIT.LST_NUM, 6)
  SCAN REST WHILE LIST_NUM = STR(LIST_TIT.LST_NUM, 6) FOR .NOT. EMPTY(QNT_REQ)
    IF LIST_TIT.FIRM = "TEL" .AND. DIV_STO.IS_MT
      SELECT DIV_STO
      REPLACE QNT_TE WITH QNT_TE+LIST_DET.QNT_REQ, ;
              QNT_MT WITH QNT_MT-LIST_DET.QNT_REQ
    ENDIF
    IF LIST_TIT.FIRM # "TEL" .AND. .NOT. DIV_STO.IS_MT
      SELECT DIV_STO
      REPLACE QNT_TE WITH QNT_TE-LIST_DET.QNT_REQ, ;
              QNT_MT WITH QNT_MT+LIST_DET.QNT_REQ
    ENDIF
    SELECT LIST_DET
  ENDSCAN
  SELECT LIST_TIT
ENDSCAN

CLOSE DATA
