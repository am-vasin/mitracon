USE PARMS
dt = DAT_START

USE ACT_S_T ORDER TAG SUP_CODE
SELECT 0

USE ACT_S ORDER TAG DOC_NUM
SELECT 0

USE SALE_TIT ORDER TAG CUS_CODE
SELECT 0

USE SALE ORDER TAG DOC_NUM
SELECT 0

USE STOCK ORDER TAG CODE
REPLACE ALL QNT_SPEC WITH 0, QNT_S_SPEC WITH 0
SELECT 0

USE SPEC_SUM ORDER TAG POS_CUS EXCLU
ZAP
SELECT 0

SELECT SALE_TIT

SCAN WHILE CUS_CODE < 0
  SELECT SALE
  SEEK LEFT(DTOS(SALE_TIT.DOC_DATE),4)+SALE_TIT.DOC_NUM
  SCAN REST WHILE SALE_TIT.DOC_DATE = DOC_DATE .AND. SALE_TIT.DOC_NUM = DOC_NUM
*    IF SALE.DOC_DATE >= dt
    SELECT SPEC_SUM
    IF .NOT. SEEK(STR(SALE.CODE,7)+STR(SALE_TIT.CUS_CODE,8))
      APPEND BLANK
    ENDIF
    REPLACE CODE WITH SALE.CODE, CUS_CODE WITH SALE_TIT.CUS_CODE, ;
            QNT  WITH QNT+SALE.QNT
*    ENDIF
    SELECT STOCK
    SEEK SALE.CODE
    IF SALE.DOC_DATE < dt
      REPLACE QNT_S_SPEC WITH QNT_S_SPEC+SALE.QNT
    ENDIF
    REPLACE QNT_SPEC WITH QNT_SPEC+SALE.QNT
    SELECT SALE
  ENDSCAN
  SELECT SALE_TIT
ENDSCAN

SELECT ACT_S_T

SCAN WHILE SUP_CODE < 0
  SELECT ACT_S
  SEEK LEFT(DTOS(ACT_S_T.DOC_DATE),4)+ACT_S_T.DOC_NUM
  SCAN REST WHILE ACT_S_T.DOC_DATE = DOC_DATE .AND. ACT_S_T.DOC_NUM = DOC_NUM
*    IF ACT_S.DOC_DATE >= dt

    SELECT SPEC_SUM
    IF .NOT. SEEK(STR(ACT_S.CODE,7)+STR(ACT_S_T.SUP_CODE,8))
      APPEND BLANK
    ENDIF
    REPLACE CODE WITH ACT_S.CODE, CUS_CODE WITH ACT_S_T.SUP_CODE, ;
            QNT  WITH QNT-ACT_S.QNT_INC
*    ENDIF

    SELECT STOCK
    SEEK ACT_S.CODE
    IF ACT_S.DOC_DATE < dt
      REPLACE QNT_S_SPEC WITH QNT_S_SPEC-ACT_S.QNT_INC
    ENDIF
    REPLACE QNT_SPEC WITH QNT_SPEC-ACT_S.QNT_INC
    SELECT ACT_S
  ENDSCAN
  SELECT ACT_S_T
ENDSCAN
CLOSE DATABASES
