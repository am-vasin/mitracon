USE Z:\MITRACON\STORE\BASE\STOCK ORDER TAG CODE
SELECT 0
USE Z:\MITRACON\STORE\BASE\ACT_S ORDER TAG SALE
SET FILTER TO FLG_BUY # "B"
SELECT 0
USE Z:\MITRACON\STORE\BASE\SALE
SELECT 0
USE Z:\MITRACON\STORE\BASE\SALE_TIT
SELECT 0
USE DIFF
SET RELATION TO CODE INTO STOCK
DN = "B013  ****"
NN = 0
SCAN FOR EXP_REP # 0
  NN = NN+1
  IF NN%10 = 0
    WAIT WIND STR(NN) NOWAIT
  ENDIF
  TMP_QNT = EXP_REP
  SELECT ACT_S
  DO WHILE TMP_QNT > 0
    IF .NOT. SEEK(STR(DIFF.CODE, 7))
      EXIT
    ENDIF
    Q = MIN(TMP_QNT, QNT_REST)
    TMP_QNT = TMP_QNT-Q
    EXIT
    SELECT SALE
    APPEND BLANK
    REPLACE FIRM		WITH "M00",			;
            DOC_NUM		WITH DN,			;
            DOC_DATE	WITH DATE(),		;
            CODE		WITH DIFF.CODE,		;
            QNT			WITH Q,				;
            QNT_REP		WITH Q,				;
            ACT_FIRM	WITH ACT_S.FIRM,	;
            ACT_NUM		WITH ACT_S.DOC_NUM,	;
            ACT_DATE	WITH ACT_S.DOC_DATE,;
            PARTY       WITH ACT_S.PARTY,   ;
            GTD_NUM		WITH ACT_S.GTD_NUM,	;
            COUNTRY		WITH ACT_S.COUNTRY,	;
            GTD_LINE	WITH ACT_S.GTD_LINE,;
            WHERE		WITH " 13"
    SELECT STOCK
    REPLACE QNT WITH QNT-Q, QNT_REP WITH QNT_REP-Q
    SELECT ACT_S
    REPLACE QNT_REST WITH QNT_REST-Q,	;
            REST_REP WITH REST_REP-Q
  ENDDO
  SELECT DIFF
ENDSCAN

SELECT SALE_TIT
APPEND BLANK
REPLACE FIRM		WITH "M00"		;
        DOC_NUM		WITH DN,		;
        DOC_DATE	WITH DATE(),	;
        DOC_TIME	WITH SECONDS(),	;
        NEW_DOC		WITH "B     ****", ;
        WHO			WITH 1,			;
        WHERE		WITH " 13"