*┌────────────────────────────────────────────────────────────────────────┐
*│   Процедура Dlv_Stat     Разработчик Андрей Васин                      │
*├────────────────────────────────────────────────────────────────────────┤
*│                                                                        │
*│                     Состояние заявки на доставку.                      │
*│                                                                        │
*└────────────────────────────────────────────────────────── 28.03.2000 ──┘
PROCEDURE Dlv_Stat
PARAMETERS d_num, d_date

PRIVATE d_year, s_sav

IF TYPE("d_date") = "D"
  d_year = LEFT(DTOS(d_date),4)
ENDIF
IF TYPE("d_date") = "N"
  d_year = STR(d_date,4)
ENDIF
IF TYPE("d_date") = "C"
  d_year = d_date
ENDIF

s_sav = SELECT()
SELECT 0
USE (base_path+"PERSONS") ORDER TAG CODE ALIAS WHO_0328 AGAIN
SELECT 0
USE (base_path+"DELIVERY") ORDER TAG DOC_NUM ALIAS DLV_0328 AGAIN

IF .NOT. SEEK(d_year+d_num)
  PRIVATE mss
  DIMENSION mss(3)
  mss(1) = ""
  mss(2) = CHR(0)+"Документ не найден!"
  mss(3) = ""
  DO Out_Mess WITH 7, "mss"
  USE
  SELECT WHO_0328
  USE
  SELECT (s_sav)
  RETURN
ENDIF

*
*  Переменные состояния для навигации
*

PRIVATE stat_type     && Тип навигации: 0 - нестандартный;
                                        1 - бланк;
                                        2 - BROWSE - таблица;
                                        3 - BROWSE - список.
PRIVATE what_do       && Имя режима.
PRIVATE menu_name     && Имя асинхронного меню.
PRIVATE last_mouse    && Время последнего нажатия звериной кнопки.
PRIVATE win_name      && Имя окна ( окон для BROWSE ).

*
*   Заполняем значениями переменные состояния...
*
stat_type  = 1
what_do    = ""
menu_name  = ""
last_mouse = 0
win_name   = PROGRAM()

*------------------------------------------------------------------------
*    Содержательная часть программы:
*

*┌─────────────────┬──────────────────────────────┬────────────┬──────────┐
*│ Техн. этап      │  Сотрудник                   │    Дата    │  Время   │
*├─────────────────┼──────────────────────────────┼────────────┼──────────┤
*│ Ввод заявки     │ ....:....!....:....!....:... │ ДД.ММ.ГГГГ │ ЧЧ:ММ:СС │
*├─────────────────┼──────────────────────────────┼────────────┼──────────┤
*│ Корр.заявки     │ ....:....!....:....!....:... │ ДД.ММ.ГГГГ │ ЧЧ:ММ:СС │
*├─────────────────┼──────────────────────────────┼────────────┼──────────┤
*│ Печать заявки   │ ....:....!....:....!....:... │ ДД.ММ.ГГГГ │ ЧЧ:ММ:СС │
*├─────────────────┼──────────────────────────────┼────────────┼──────────┤
*│ Вызов курьера   │ ....:....!....:....!....:... │ ДД.ММ.ГГГГ │ ЧЧ:ММ:СС │
*├─────────────────┼──────────────────────────────┼────────────┼──────────┤
*│ Отправка курьера│ ....:....!....:....!....:... │ ДД.ММ.ГГГГ │ ЧЧ:ММ:СС │
*├─────────────────┼──────────────────────────────┼────────────┼──────────┤
*│ Закрытие заявки │ ....:....!....:....!....:... │ ДД.ММ.ГГГГ │ ЧЧ:ММ:СС │
*└─────────────────┴──────────────────────────────┴────────────┴──────────┘
*                                    < OK >                    

PRIVATE ex
ex = 1
*------------------------------------------------------------------------

PUSH KEY CLEAR       && На всякий пожарный случай!
DO Prp_Nav_2
DO D_Win_N WITH 17, 76, "Состояние заявки N "+ALLTRIM(DOC_NUM)+" "+DTOC(DOC_DATE)

*------------------------------------------------------------------------
*      Ввод полей бланка
*
@ 1, 0 CLEAR TO WROWS()-1, WCOLS()-1
@ 0, 0 SAY ""
TEXT
 ┌─────────────────┬──────────────────────────────┬────────────┬──────────┐
 │ Техн. этап      │  Сотрудник                   │    Дата    │  Время   │
 ├─────────────────┼──────────────────────────────┼────────────┼──────────┤
 │ Ввод заявки     │                              │            │          │
 ├─────────────────┼──────────────────────────────┼────────────┼──────────┤
 │ Корр.заявки     │                              │            │          │
 ├─────────────────┼──────────────────────────────┼────────────┼──────────┤
 │ Печать заявки   │                              │            │          │
 ├─────────────────┼──────────────────────────────┼────────────┼──────────┤
 │ Вызов курьера   │                              │            │          │
 ├─────────────────┼──────────────────────────────┼────────────┼──────────┤
 │ Отправка курьера│                              │            │          │
 ├─────────────────┼──────────────────────────────┼────────────┼──────────┤
 │ Закрытие заявки │                              │            │          │
 └─────────────────┴──────────────────────────────┴────────────┴──────────┘
ENDTEXT
PRIVATE nm_w
IF .NOT. SEEK(SALESMAN, "WHO_0328")
  nm_w = "?"
ELSE
  nm_w = ALLTRIM(WHO_0328.FAMILY)+" "+LEFT(WHO_0328.NAME,1)+" "+LEFT(WHO_0328.S_NAME,1)
ENDIF
@  4, 21 SAY nm_w
@  4, 52 SAY DTOC(ENTER_DAT)
@  4, 65 SAY ENTER_TIM

IF .NOT. EMPTY(MOD_DATE)
  IF .NOT. SEEK(WHO_MOD, "WHO_0328")
    nm_w = "?"
  ELSE
    nm_w = ALLTRIM(WHO_0328.FAMILY)+" "+LEFT(WHO_0328.NAME,1)+" "+LEFT(WHO_0328.S_NAME,1)
  ENDIF
  @  6, 21 SAY nm_w
  @  6, 52 SAY DTOC(MOD_DATE)
  @  6, 65 SAY MOD_TIME
ENDIF

IF .NOT. EMPTY(READ_DATE)
  IF .NOT. SEEK(WHO_READ, "WHO_0328")
    nm_w = "?"
  ELSE
    nm_w = ALLTRIM(WHO_0328.FAMILY)+" "+LEFT(WHO_0328.NAME,1)+" "+LEFT(WHO_0328.S_NAME,1)
  ENDIF
  @  8, 21 SAY nm_w
  @  8, 52 SAY DTOC(READ_DATE)
  @  8, 65 SAY READ_TIME
ENDIF

IF .NOT. EMPTY(CALL_DATE)
  IF .NOT. SEEK(WHO_CALL, "WHO_0328")
    nm_w = "?"
  ELSE
    nm_w = ALLTRIM(WHO_0328.FAMILY)+" "+LEFT(WHO_0328.NAME,1)+" "+LEFT(WHO_0328.S_NAME,1)
  ENDIF
  @ 10, 21 SAY nm_w
  @ 10, 52 SAY DTOC(CALL_DATE)
  @ 10, 65 SAY CALL_TIM
ENDIF

IF .NOT. EMPTY(GAVE_DATE)
  IF .NOT. SEEK(WHO_GAVE, "WHO_0328")
    nm_w = "?"
  ELSE
    nm_w = ALLTRIM(WHO_0328.FAMILY)+" "+LEFT(WHO_0328.NAME,1)+" "+LEFT(WHO_0328.S_NAME,1)
  ENDIF
  @ 12, 21 SAY nm_w
  @ 12, 52 SAY DTOC(GAVE_DATE)
  @ 12, 65 SAY GAVE_TIME
ENDIF

IF .NOT. EMPTY(TERM_DATE)
  IF .NOT. SEEK(WHO_TERM, "WHO_0328")
    nm_w = "?"
  ELSE
    nm_w = ALLTRIM(WHO_0328.FAMILY)+" "+LEFT(WHO_0328.NAME,1)+" "+LEFT(WHO_0328.S_NAME,1)
  ENDIF
  @ 12, 21 SAY nm_w
  @ 12, 52 SAY DTOC(TERM_DATE)
  @ 12, 65 SAY TERM_TIME
ENDIF

@ WROWS()-1, FLOOR(WCOLS()/2-3) GET ex PICTURE "@*HT \ OK "

READ CYCLE

*--------------------------------------------------------------------------

POP KEY
RELEASE WINDOW (win_name)
USE
SELECT WHO_0328
USE
SELECT (s_sav)
RETURN
